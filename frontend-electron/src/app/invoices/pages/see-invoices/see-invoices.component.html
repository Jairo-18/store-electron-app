<!-- Componente reutilizable -->
<app-base-page
  contentTitle="Gestiona las facturas de tu hotel"
  [showContentTitle]="true"
  contentInfo="Mira los movimientos realizados dentro de tu hotel"
  [showContentInfo]="true"
>
  <!-- Botón de dialogo para crear factura -->
  <div slot="actions" class="w-full md:w-[25%]">
    <button
      mat-fab
      extended="true"
      class="!w-full"
      (click)="openCreateDialog()"
    >
      Crear factura
    </button>
  </div>

  <!-- Condición, si no es mobile muestre en destok -->
  @if (!isMobile) {
  <!-- Filtros de búsqueda -->
  <app-search-fields
    [searchFields]="searchFields"
    [form]="form"
    [debounceTime]="300"
    (searchSubmit)="onSearchSubmit($event)"
    (searchChange)="onSearchChange($event)"
  ></app-search-fields>

  <!-- Limpiar filtros -->
  <section class="flex w-full justify-end items-center gap-2 mt-2">
    <div class="w-[24%]">
      <button
        class="!w-full"
        mat-fab
        extended="true"
        color="warn"
        (click)="searchComponent.reset()"
        [disabled]="!showClearButton"
      >
        Limpiar filtros
      </button>
    </div>
  </section>

  <div class="mt-4">
    <div class="overflow-auto mb-3">
      <!-- Condición del loader -->
      @if (loading) {
      <app-loader></app-loader>
      } @else if (dataSource.data.length > 0) {
      <!-- Tabla de facturas -->
      <table mat-table [dataSource]="dataSource" matSort>
        <!-- Tipo de factura -->
        <ng-container matColumnDef="invoiceType">
          <th mat-header-cell *matHeaderCellDef class="center-text">
            Tipo Factura
          </th>
          <td
            mat-cell
            *matCellDef="let invoice"
            class="center-text font-bold"
            [ngClass]="{
              '!text-green-700': invoice.invoiceType?.code === 'FV',
              '!text-red-700': invoice.invoiceType?.code === 'FC',
              '!text-yellow-700': invoice.invoiceType?.code === 'CO'
            }"
          >
            {{ invoice.invoiceType?.code || '---' }}
          </td>
        </ng-container>

        <!-- Código -->
        <ng-container matColumnDef="code">
          <th mat-header-cell *matHeaderCellDef class="center-text">Código</th>
          <td mat-cell *matCellDef="let invoice" class="center-text">
            {{ invoice?.code || '---' }}
          </td>
        </ng-container>

        <!-- Nombre del cliente -->
        <ng-container matColumnDef="clientName">
          <th mat-header-cell *matHeaderCellDef class="center-text">Cliente</th>
          <td mat-cell *matCellDef="let invoice">
            {{ invoice?.clientName || '---' }}
          </td>
        </ng-container>

        <!-- Número de identificación del cliente -->
        <ng-container matColumnDef="clientIdentification">
          <th mat-header-cell *matHeaderCellDef class="center-text">
            Identificación
          </th>
          <td mat-cell *matCellDef="let invoice">
            {{ invoice?.clientIdentification || '---' }}
          </td>
        </ng-container>

        <!-- Subtotal de la factura  -->
        <ng-container matColumnDef="subtotalWithoutTax">
          <th mat-header-cell *matHeaderCellDef class="center-text">
            Subtotal
          </th>
          <td
            mat-cell
            *matCellDef="let invoice"
            class="right-text font-bold"
            [ngClass]="{
              '!text-green-700': invoice.invoiceType?.code === 'FV',
              '!text-red-700': invoice.invoiceType?.code === 'FC',
              '!text-yellow-700': invoice.invoiceType?.code === 'CO'
            }"
          >
            {{ invoice?.subtotalWithoutTax ?? 0 | formatCop }}
          </td>
        </ng-container>

        <ng-container matColumnDef="startDate">
          <th mat-header-cell *matHeaderCellDef class="center-text">Fecha</th>
          <td mat-cell *matCellDef="let invoice" class="right-text">
            {{
              invoice.startDate
                ? (invoice.startDate | date : 'dd/MM/yyyy  ')
                : 'N/A'
            }}
          </td>
        </ng-container>

        <!-- IVA de la factura -->
        <ng-container matColumnDef="totalTaxes">
          <th mat-header-cell *matHeaderCellDef class="center-text">
            Impuesto
          </th>
          <td mat-cell *matCellDef="let invoice" class="right-text">
            {{ invoice?.totalTaxes ?? 0 | formatCop }}
          </td>
        </ng-container>

        <!-- Total de la factura -->
        <ng-container matColumnDef="total">
          <th mat-header-cell *matHeaderCellDef class="center-text">Total</th>
          <td
            mat-cell
            *matCellDef="let invoice"
            class="right-text font-bold"
            [ngClass]="{
              '!text-green-700': invoice.invoiceType?.code === 'FV',
              '!text-red-700': invoice.invoiceType?.code === 'FC',
              '!text-yellow-700': invoice.invoiceType?.code === 'CO'
            }"
          >
            {{ invoice?.total ?? 0 | formatCop }}
          </td>
        </ng-container>

        <!-- Tipo de pago de la factura -->
        <ng-container matColumnDef="payType">
          <th mat-header-cell *matHeaderCellDef class="center-text">
            Tipo Pago
          </th>
          <td mat-cell *matCellDef="let invoice" class="font-bold">
            {{ invoice?.payType?.name || 'NO APLICA' }}
          </td>
        </ng-container>

        <!-- Estado de pago de la factura -->
        <ng-container matColumnDef="paidType">
          <th mat-header-cell *matHeaderCellDef class="center-text">
            Estado Pago
          </th>
          <td
            mat-cell
            *matCellDef="let invoice"
            class="font-bold"
            [ngClass]="{
              '!text-green-700':
                invoice?.paidType?.name === 'Pagado' ||
                invoice?.paidType?.name === 'PAGADO' ||
                invoice?.paidType?.name === 'RESERVADO - PAGADO' ||
                invoice?.paidType?.name === 'Reservado - Pagado',
              '!text-red-700':
                invoice?.paidType?.name === 'PENDIENTE' ||
                invoice?.paidType?.name === 'Pendiente' ||
                invoice?.paidType?.name === 'RESERVADO - PENDIENTE' ||
                invoice?.paidType?.name === 'Reservado - Pendiente'
            }"
          >
            {{ invoice?.paidType?.name || 'NO APLICA' }}
          </td>
        </ng-container>

        <!-- Tabla de facturas -->
        <ng-container matColumnDef="invoiceElectronic">
          <th mat-header-cell *matHeaderCellDef class="center-text">F. Elec</th>
          <td mat-cell *matCellDef="let invoice" class="center-text">
            {{
              invoice.invoiceElectronic === true
                ? 'Sí'
                : invoice.invoiceElectronic === false
                ? 'No'
                : ''
            }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="center-text">
            Acciones
          </th>
          <td mat-cell *matCellDef="let invoice">
            <button mat-icon-button [matMenuTriggerFor]="menu">
              <mat-icon>more_vert</mat-icon>
            </button>

            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="openEditDialog(invoice.invoiceId)">
                <mat-icon class="blue-color">edit_document</mat-icon>
                <span>Editar factura</span>
              </button>
              <button
                mat-menu-item
                [routerLink]="['..', invoice.invoiceId, 'edit']"
              >
                <mat-icon class="blue-color">edit</mat-icon>
                <span>Editar detalles</span>
              </button>
              <button
                mat-menu-item
                (click)="onDownloadInvoice(invoice.invoiceId)"
              >
                <mat-icon class="green-color">print</mat-icon>
                <span>Descargar</span>
              </button>
              <button
                mat-menu-item
                (click)="openDeleteInvoiceDialog(invoice.invoiceId)"
              >
                <mat-icon class="red-color">delete</mat-icon>
                <span>Eliminar</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>

      <!-- Paginador -->

      <mat-paginator
        [length]="paginationParams.total"
        [pageSize]="paginationParams.perPage"
        [pageSizeOptions]="[5, 10, 25, 100]"
        [pageIndex]="(paginationParams.page || 0) - 1"
        (page)="onChangePagination($event)"
      ></mat-paginator>
      } @else {
      <div class="w-full justify-center items-center flex">
        <p>No se encontraron facturas.</p>
      </div>
      }
    </div>
  </div>
  } @else {
  <mat-tab-group
    [(selectedIndex)]="selectedTabIndex"
    (selectedIndexChange)="onTabChange($event)"
  >
    <mat-tab label="Búsqueda">
      <div class="mt-3 px-2">
        <app-search-fields
          [searchFields]="searchFields"
          [debounceTime]="0"
          (searchSubmit)="onSearchSubmit($event)"
          (searchChange)="onSearchChange($event)"
        ></app-search-fields>
      </div>

      <section class="flex flex-col w-full gap-2 p-2">
        <button
          mat-fab
          extended="true"
          class="!w-full"
          color="warn"
          (click)="searchComponent.reset()"
          [disabled]="!showClearButton"
        >
          Limpiar filtros
        </button>
        <button
          mat-fab
          extended="true"
          class="!w-full"
          (click)="searchComponent.submitSearch(); selectedTabIndex = 1"
        >
          Buscar
        </button>
      </section>
    </mat-tab>

    <mat-tab label="Resultados">
      <app-loader *ngIf="loading"></app-loader>
      <div
        *ngIf="!loading && dataSource.data.length > 0"
        class="overflow-auto mb-3"
      >
        <table mat-table [dataSource]="dataSource" matSort>
          <ng-container matColumnDef="invoiceType">
            <th mat-header-cell *matHeaderCellDef class="center-text">
              Tipo de Factura
            </th>
            <td
              mat-cell
              *matCellDef="let invoice"
              class="center-text font-bold"
              [ngClass]="{
                '!text-green-700': invoice.invoiceType?.code === 'FV',
                '!text-red-700': invoice.invoiceType?.code === 'FC',
                '!text-yellow-700': invoice.invoiceType?.code === 'CO'
              }"
            >
              {{ invoice.invoiceType?.name || '' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="code">
            <th mat-header-cell *matHeaderCellDef class="center-text">
              Código
            </th>
            <td mat-cell *matCellDef="let invoice" class="center-text">
              {{ invoice?.code || '' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="clientName">
            <th mat-header-cell *matHeaderCellDef class="center-text">
              Cliente
            </th>
            <td mat-cell *matCellDef="let invoice">
              {{ invoice?.clientName || '' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="clientIdentification">
            <th mat-header-cell *matHeaderCellDef class="center-text">
              Identificación Cliente
            </th>
            <td mat-cell *matCellDef="let invoice">
              {{ invoice?.clientIdentification || '' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="startDate">
            <th mat-header-cell *matHeaderCellDef class="center-text">Fecha</th>
            <td mat-cell *matCellDef="let invoice" class="right-text">
              {{
                invoice.startDate
                  ? (invoice.startDate | date : 'dd/MM/yyyy  ')
                  : 'N/A'
              }}
            </td>
          </ng-container>

          <ng-container matColumnDef="subtotalWithoutTax">
            <th mat-header-cell *matHeaderCellDef class="center-text">
              Subtotal
            </th>
            <td
              mat-cell
              *matCellDef="let invoice"
              class="right-text font-bold"
              [ngClass]="{
                '!text-green-700': invoice.invoiceType?.code === 'FV',
                '!text-red-700': invoice.invoiceType?.code === 'FC',
                '!text-yellow-700': invoice.invoiceType?.code === 'CO'
              }"
            >
              {{ invoice?.subtotalWithoutTax ?? 0 | formatCop }}
            </td>
          </ng-container>

          <!-- IVA de la factura -->
          <ng-container matColumnDef="totalTaxes">
            <th mat-header-cell *matHeaderCellDef class="center-text">
              Impuesto
            </th>
            <td mat-cell *matCellDef="let invoice" class="right-text">
              {{ invoice?.totalTaxes ?? 0 | formatCop }}
            </td>
          </ng-container>

          <ng-container matColumnDef="total">
            <th mat-header-cell *matHeaderCellDef class="center-text">Total</th>
            <td
              mat-cell
              *matCellDef="let invoice"
              class="right-text font-bold"
              [ngClass]="{
                '!text-green-700': invoice.invoiceType?.code === 'FV',
                '!text-red-700': invoice.invoiceType?.code === 'FC',
                '!text-yellow-700': invoice.invoiceType?.code === 'CO'
              }"
            >
              {{ invoice?.total ?? 0 | formatCop }}
            </td>
          </ng-container>

          <ng-container matColumnDef="payType">
            <th mat-header-cell *matHeaderCellDef class="center-text">
              Tipo de Pago
            </th>
            <td mat-cell *matCellDef="let invoice">
              {{ invoice.payType?.name || '' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="paidType">
            <th mat-header-cell *matHeaderCellDef class="center-text">
              Estado de Pago
            </th>
            <td
              mat-cell
              *matCellDef="let invoice"
              class="font-bold"
              [ngClass]="{
                '!text-green-700':
                  invoice?.paidType?.name === 'Pagado' ||
                  invoice?.paidType?.name === 'PAGADO' ||
                  invoice?.paidType?.name === 'RESERVADO - PAGADO' ||
                  invoice?.paidType?.name === 'Reservado - Pagado',
                '!text-red-700':
                  invoice?.paidType?.name === 'PENDIENTE' ||
                  invoice?.paidType?.name === 'Pendiente' ||
                  invoice?.paidType?.name === 'RESERVADO - PENDIENTE' ||
                  invoice?.paidType?.name === 'Reservado - Pendiente'
              }"
            >
              {{ invoice?.paidType?.name || '' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="taxeType">
            <th mat-header-cell *matHeaderCellDef class="center-text">
              Tipo impuesto
            </th>
            <td mat-cell *matCellDef="let invoice">
              {{ invoice.taxeType?.name || '' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="invoiceElectronic">
            <th mat-header-cell *matHeaderCellDef class="center-text">
              F. Elec
            </th>
            <td mat-cell *matCellDef="let invoice" class="center-text">
              {{
                invoice.invoiceElectronic === true
                  ? 'Sí'
                  : invoice.invoiceElectronic === false
                  ? 'No'
                  : ''
              }}
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="center-text">
              Acciones
            </th>
            <td mat-cell *matCellDef="let invoice">
              <button
                mat-icon-button
                [matMenuTriggerFor]="menu"
                (click)="selectedInvoice = invoice"
              >
                <mat-icon>more_vert</mat-icon>
              </button>

              <mat-menu #menu="matMenu">
                <button
                  mat-menu-item
                  (click)="openEditDialog(invoice.invoiceId)"
                >
                  <mat-icon class="blue-color">edit_document</mat-icon>
                  <span>Editar factura</span>
                </button>
                <button
                  mat-menu-item
                  [routerLink]="['..', selectedInvoice?.invoiceId, 'edit']"
                >
                  <mat-icon>edit</mat-icon>
                  <span class="blue-color">Editar detalles</span>
                </button>
                <button
                  mat-menu-item
                  (click)="onDownloadInvoice(invoice.invoiceId)"
                >
                  <mat-icon>print</mat-icon>
                  <span class="green-color">Descargar</span>
                </button>

                <button
                  mat-menu-item
                  (click)="openDeleteInvoiceDialog(selectedInvoice?.invoiceId)"
                >
                  <mat-icon class="red-color">delete</mat-icon>
                  <span>Eliminar</span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </div>
      <div *ngIf="!loading && dataSource.data.length === 0" class="text-center">
        <p>No se encontraron facturas.</p>
      </div>
      <mat-paginator
        [length]="paginationParams.total"
        [pageSize]="paginationParams.perPage"
        [pageSizeOptions]="[5, 10, 25, 100]"
        [pageIndex]="(paginationParams.page || 0) - 1"
        (page)="onChangePagination($event)"
      ></mat-paginator>
    </mat-tab>
  </mat-tab-group>
  }
  <app-invoice-pdf
    class="hidden"
    *ngIf="invoiceToPrintData"
    [invoiceData]="invoiceToPrintData"
    #invoiceToPrintRef
  ></app-invoice-pdf>
</app-base-page>
